/**
 * x402 Discovery Document
 *
 * GET /.well-known/x402 â†’ JSON listing all x402-enabled endpoints.
 */

import { NextResponse } from "next/server";
import { readFile } from "fs/promises";
import { join } from "path";
import { getBaseUrl } from "@/server/x402";
import { createLogger } from "@/lib/logger";

const log = createLogger("x402-discovery");

export async function GET(): Promise<NextResponse> {
  const baseUrl = getBaseUrl();

  const resources: string[] = [
    `${baseUrl}/api/x402/upload`,
    `${baseUrl}/api/x402/uploads`,
    `${baseUrl}/api/x402/download/{uploadId}`,
  ];

  // Load instructions from llms.txt
  let instructions = "";
  try {
    const llmsTxtPath = join(process.cwd(), "public", "llms.txt");
    instructions = await readFile(llmsTxtPath, "utf-8");
  } catch (error) {
    log.error("Failed to load llms.txt", {
      error: error instanceof Error ? error.message : String(error),
    });
    instructions = `# x402 Upload API\n\nS3-backed file uploads via x402 micropayments. USDC on Base.\n\nVisit ${baseUrl}/llms.txt for documentation.`;
  }

  return NextResponse.json(
    {
      version: 1,
      description:
        "S3-backed file uploads via x402 micropayments. Tiers: 10mb ($0.10), 100mb ($1.00), 1gb ($10.00).",
      resources,
      ownershipProofs: [
        "0x0000000000000000000000008e6af8ed94e87b4402d0272c5d6b0d47f0483e7c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000124406f52fd0000000000000000000000002b4e26e1f32c7fbf076563ad49a86b69ae018216000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000023a3a9b70000000000000000000000000000000000000000000000000000000000000002be445780eeddc4321ff957c7fb8ac80866d1f281f2bdac807ac00d38dc33e8403e21ca5d0d341cc94b8dcc9c79b36f691ce99d74cbf28511a1f3a3e14885eefdbd71e7ae4046dbcd345631a04e70b360434e724d558d4dbce1a1235e0c5dbe8b7e673ff35925f52d6b485ac8fdd324d9e0ee0163e09e8c3f2b7ea44fc4f727450000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000001700000000000000000000000000000000000000000000000000000000000000010798636cf4622bf2f72ad8bb47093471a7885b63fe3c997e49910cf354720cfa2becbba024f625ec6b78296ed64821e746682ccd5d04f792cff06ac58988c55e000000000000000000000000000000000000000000000000000000000000002506817f31b6ccc1234a424df1fff4840b8ed06f3671ea34bfbfabcb0b04a176ac1d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000897b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a225a5f734f664c52716e66622d67566c6639376d567269526254726d6a4f32563167593775633752526f6a67222c226f726967696e223a2268747470733a2f2f7465616d732e73706c6974732e6f7267222c2263726f73734f726967696e223a66616c73657d00000000000000000000000000000000000000000000006492649264926492649264926492649264926492649264926492649264926492",
      ],
      instructions,
    },
    {
      status: 200,
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "GET",
        "Access-Control-Allow-Headers": "Content-Type",
      },
    },
  );
}
